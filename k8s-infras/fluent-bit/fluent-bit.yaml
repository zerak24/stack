kind: DaemonSet
replicaCount: 1
image:
  repository: cr.fluentbit.io/fluent/fluent-bit
  tag:
  digest:
  pullPolicy: IfNotPresent
testFramework:
  enabled: false
config:
  outputs: |
    [OUTPUT]
        Name http
        tls off
        Match kube.*
        Host clickhouse.default.svc.cluster.local.
        Port 8123
        URI /?query=INSERT+INTO+fluentbit.kube+FORMAT+JSONEachRow
        format json_stream
        json_date_key timestamp
        json_date_format epoch
        http_user default
        http_passwd cf13d373b2e8c30bb4216e63c549d71f8e784b62
  filters: |
    [FILTER]
        Name kubernetes
        Match kube.*
        Merge_Log On
        Keep_Log Off
        K8S-Logging.Parser On
        K8S-Logging.Exclude On

    [FILTER]
        Name nest
        Match *
        Operation nest
        Wildcard *
        Nest_under log

    [FILTER]
        Name lua
        Match *
        script /fluent-bit/scripts/functions.lua
        call set_fields

luaScripts:
  functions.lua: |
    function set_fields(tag, timestamp, record)
          record['host'] = record['log']['kubernetes']['host']
          record['log']['kubernetes']['host'] = nil
          record['pod_name'] = record['log']['kubernetes']['pod_name']
          record['log']['kubernetes']['pod_name'] = nil
          return 2, timestamp, record
    end